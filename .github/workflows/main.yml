# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [master]
    paths-ignore: # run if anything different from these is modified
      - "docs/**"
      - "mkdocs.yml"

  pull_request:
    branches: [master]
    paths-ignore:
      - "docs/**"
      - "mkdocs.yml"

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# When a Push is made on an existing branch/PR
# it cancels any pre running job and
# let only the latest executing
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  PYTHON_MINIMAL: '["3.9", "3.13"]'
  PYTHON_FULL: '["3.9", "3.10", "3.11", "3.12", "3.13"]'
  PYTHON_LATEST: '3.13'

jobs:
  linter:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_LATEST }}
      - name: Upgrade PIP
        run: pip install --user --upgrade pip
      - name: Install and lint
        run: make clean install run-pre-commit

  build:
    needs: linter
    runs-on: ubuntu-latest
    outputs:
      PYTHON_FULL: ${{ env.PYTHON_FULL }}
      PYTHON_MINIMAL: ${{ env.PYTHON_MINIMAL }}
    steps:
      # Setup python version matrix (can't use 'env' in the matrix)
      - id: set-matrix
        run: |
          echo "PYTHON_FULL=$PYTHON_FULL" >> $GITHUB_OUTPUT
          echo "PYTHON_MINIMAL=$PYTHON_MINIMAL" >> $GITHUB_OUTPUT
        shell: bash
      # Actual build
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          # build requires the lowerbound python we support
          python-version: "3.9"
      - name: Upgrade PIP
        run: pip install --user --upgrade pip
      - name: Install build dependencies
        run: pip install --user .[release]
      - name: Build wheel
        run: make dist
      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: dynaconf_dist
          path: dist/
          if-no-files-found: "error"
          overwrite: true
          retention-days: 1
  
  install_test:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJSON(needs.build.outputs.PYTHON_FULL) }}
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Install from wheel
        uses: ./.github/actions/install-from-wheel
        with:
          python-version: ${{ matrix.python-version }}
          os: ${{ runner.os }}
      - name: Install project and test cli
        run: |
          dynaconf init -v FOO=running_on_ci -y
          dynaconf -i config.settings write toml -v OTHERVALUE=Hello_CI -y
          dynaconf -i config.settings list | grep -c running_on_ci
          dynaconf -i config.settings list | grep -c Hello_CI
          dynaconf --version

  unit_tests_linux:
    needs: install_test
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJSON(needs.build.outputs.PYTHON_MINIMAL) }}
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Install from wheel
        uses: ./.github/actions/install-from-wheel
        with:
          python-version: ${{ matrix.python-version }}
          dependencies: test
          os: linux
      - name: Run tests
        run: make citest
      - name: Publish Junit Test Results
        uses: EnricoMi/publish-unit-test-result-action@v1
        continue-on-error: true
        if: always()
        with:
          files: junit/**/*.xml
          check_name: Test Results (Python ${{ matrix.python-version }})

      - name: "Upload coverage to Codecov"
        if: ${{ matrix.python-version == env.PYTHON_LATEST }}
        uses: codecov/codecov-action@v4
        continue-on-error: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          files: coverage.xml
          fail_ci_if_error: true

  unit_tests_mac:
    needs: install_test
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJSON(needs.build.outputs.PYTHON_MINIMAL) }}
        os: [macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Install from wheel
        uses: ./.github/actions/install-from-wheel
        with:
          python-version: ${{ matrix.python-version }}
          dependencies: test
          os: macos
      - name: Run tests
        run: py.test -v --cov-config .coveragerc --cov=dynaconf -l tests/ --junitxml=junit/test-results.xml -m "not integration"

  functional_tests_linux_mac:
    needs:
      - unit_tests_linux
      - unit_tests_mac
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJSON(needs.build.outputs.PYTHON_MINIMAL) }}
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Install from wheel
        uses: ./.github/actions/install-from-wheel
        with:
          python-version: ${{ matrix.python-version }}
          dependencies: test
          os: linux
      - name: Run functional tests
        run: make test_functional

  unit_tests_windows:
    needs: install_test
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJSON(needs.build.outputs.PYTHON_MINIMAL) }}
        os: [windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Install from wheel
        uses: ./.github/actions/install-from-wheel
        with:
          python-version: ${{ matrix.python-version }}
          dependencies: test
          os: windows
      - name: run tests
        run: py.test -v -l tests --junitxml=junit/test-results.xml -m "not integration"

  functional_tests_windows:
    needs: unit_tests_windows
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJSON(needs.build.outputs.PYTHON_MINIMAL) }}
        os: [windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Install from wheel
        uses: ./.github/actions/install-from-wheel
        with:
          python-version: ${{ matrix.python-version }}
          dependencies: test
          os: windows
      - name: run tests
        run: python tests_functional/runtests.py

  redis:
    needs: functional_tests_linux_mac
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJSON(needs.build.outputs.PYTHON_MINIMAL) }}
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    services:
      redis:
        image: redis
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      - name: Install from wheel
        uses: ./.github/actions/install-from-wheel
        with:
          python-version: ${{ matrix.python-version }}
          dependencies: test
          os: linux
      - name: Run functional tests
        run: make test_redis

  vault:
    needs: functional_tests_linux_mac
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJSON(needs.build.outputs.PYTHON_MINIMAL) }}
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    services:
      vault:
        image: hashicorp/vault:latest
        ports:
          - 8200:8200
        env:
          VAULT_DEV_ROOT_TOKEN_ID: myroot

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install from wheel
        uses: ./.github/actions/install-from-wheel
        with:
          python-version: ${{ matrix.python-version }}
          dependencies: test
          os: linux
      - name: Run functional tests
        run: make test_vault

  checkpoint:
    runs-on: ubuntu-latest
    needs:
      - linter
      - install_test
      - unit_tests_windows
      - unit_tests_mac
      - unit_tests_linux
      - functional_tests_linux_mac
      - functional_tests_windows
      - redis
      - vault
    steps:
      - name: All tests has passed
        run: echo "All tests has passed"
